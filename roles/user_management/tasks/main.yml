- name: Ensure users primary group are created
  group:
    name: "{{ item.name }}"
    gid: "{{ item.gid }}"
  loop: "{{ users_primary_group }}"

- name: Automate user creation with correct secondary groups, UID, and state
  user: 
    name: "{{ item.name }}"
    uid: "{{ item.uid }}"
    group: "{{ item.group | default (omit) }}" # Special keyword that doesn't pass the parameter if it doesn't exist
    groups: "{{ item.groups }}"
    shell: "{{ item.shell }}"
    comment: "{{item.comment }}"
  loop: "{{ user_info }}"
